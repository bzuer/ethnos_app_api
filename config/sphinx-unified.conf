# Sphinx Simplified Configuration (works-only for search)
# Date: 2025-10-10
# Simplified: venues and persons use MariaDB directly for consistency

# =============================================================================
# DATA SOURCES
# =============================================================================

source works_src
{
    type = mysql
    sql_host = localhost
    sql_user = api_dev
    sql_pass = s0urc3_v3nv
    sql_db = data_db
    sql_port = 3306

    sql_query_pre = SET NAMES 'utf8mb4'
    sql_query_pre = SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED

    sql_query = \
        SELECT \
            id, \
            title, \
            subtitle, \
            abstract, \
            author_string, \
            venue_name, \
            doi, \
            created_ts, \
            year, \
            work_type, \
            language, \
            open_access, \
            peer_reviewed, \
            subjects_string \
        FROM sphinx_works_summary
        
    # Attributes
    sql_attr_uint   = year
    sql_attr_uint   = created_ts
    sql_attr_uint   = open_access
    sql_attr_uint   = peer_reviewed
    sql_attr_string = work_type
    sql_attr_string = language
    
    # Fields (for full-text)
    sql_field_string = title
    sql_field_string = subtitle
    sql_field_string = abstract
    sql_field_string = author_string
    sql_field_string = venue_name
    sql_field_string = doi
    sql_field_string = subjects_string
}

source persons_src
{
    type = mysql
    sql_host = localhost
    sql_user = api_dev
    sql_pass = s0urc3_v3nv
    sql_db = data_db
    sql_port = 3306

    sql_query_pre = SET NAMES 'utf8mb4'
    sql_query_pre = SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED

    sql_query = \
        SELECT \
            id, \
            search_content, \
            preferred_name, \
            is_verified, \
            total_works, \
            latest_publication_year \
        FROM sphinx_persons_summary
        
    # Attributes  
    sql_attr_uint   = is_verified
    sql_attr_uint   = total_works
    sql_attr_uint   = latest_publication_year
    
    # Fields (for full-text)
    sql_field_string = search_content
    sql_field_string = preferred_name
}

# REMOVED: venues_metrics_src source - no longer needed since venues endpoint uses MariaDB directly
# This eliminates the "Unknown column 'v.scopus_source_id'" error during indexation

# =============================================================================
# INDEXES
# =============================================================================

index works_poc
{
    source = works_src
    path = /home/server/api/runtime/sphinx/works_poc
    
    morphology = stem_en
    charset_table = 0..9, A..Z->a..z, _, a..z
    index_exact_words = 1
    min_prefix_len = 3
    expand_keywords = 1
    min_word_len = 2
    html_strip = 1
    html_remove_elements = style, script
}

index persons_poc
{
    source = persons_src
    path = /home/server/api/runtime/sphinx/persons_poc
    
    morphology = stem_en
    charset_table = 0..9, A..Z->a..z, _, a..z
    index_exact_words = 1
    min_prefix_len = 2
    expand_keywords = 1
    min_word_len = 2
    html_strip = 1
    html_remove_elements = style, script
}

# REMOVED: venues_metrics_poc index - no longer needed since venues endpoint uses MariaDB directly

# Real-Time index for incremental updates
index works_rt
{
    type = rt
    path = /home/server/api/runtime/sphinx/works_rt
    
    # RT fields
    rt_field = title
    rt_field = subtitle
    rt_field = abstract
    rt_field = author_string
    rt_field = venue_name
    rt_field = doi
    rt_field = subjects_string
    
    # RT attributes
    rt_attr_uint   = year
    rt_attr_uint   = created_ts
    rt_attr_uint   = open_access
    rt_attr_uint   = peer_reviewed
    rt_attr_string = work_type
    rt_attr_string = language
    
    morphology = stem_en
    charset_table = 0..9, A..Z->a..z, _, a..z
    index_exact_words = 1
    min_prefix_len = 3
    expand_keywords = 1
    min_word_len = 2
    html_strip = 1
    html_remove_elements = style, script
}

# =============================================================================
# INDEXER SETTINGS
# =============================================================================

indexer
{
    mem_limit = 1024M
    max_iops = 100
    max_iosize = 1048576
    max_xmlpipe2_field = 16M
    write_buffer = 16M
    max_file_field_buffer = 32M
}

# =============================================================================
# SEARCHD DAEMON SETTINGS
# =============================================================================

searchd
{
    listen = 127.0.0.1:9312
    listen = 127.0.0.1:9306:mysql41
    
    log = /home/server/api/logs/sphinx-daemon.log
    query_log = /home/server/api/logs/sphinx-query.log
    pid_file = /home/server/api/logs/sphinx.pid
    
    seamless_rotate = 1
    preopen_indexes = 1
    unlink_old = 1
    
    max_children = 30
    max_packet_size = 32M
    
    read_timeout = 5
    client_timeout = 300
    max_filters = 256
    max_filter_values = 65536
    query_log_min_msec = 50
    binlog_path = /home/server/api/runtime/sphinx/binlog
    binlog_max_log_size = 128M
    binlog_flush = 2
    
    workers = threads
}
